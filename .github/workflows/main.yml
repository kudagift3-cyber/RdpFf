name: AvicaRDP

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # Auto restart every 6 hours

jobs:
  build:
    name: Start Building...
    runs-on: windows-latest
    timeout-minutes: 350

    steps:
      - name: Download Required Files
        run: |
          Write-Host "🚀 Downloading setup files..." -ForegroundColor Green

          # setup.py (for GoFile upload)
          @"
import os
import requests

avica_id = "123-456-789"
avica_pass = "TheDisa1a"
username = "runneradmin"

with open("avica.txt", "w") as f:
    f.write("🔐 Avica RDP Connection Info\n")
    f.write("=============================\n")
    f.write(f"👤 User: {username}\n")
    f.write(f"🆔 Avica ID: {avica_id}\n")
    f.write(f"🔑 Password: {avica_pass}\n")

def upload_to_gofile(file_path):
    try:
        server = requests.get("https://api.gofile.io/getServer").json()["data"]["server"]
        url = f"https://{server}.gofile.io/uploadFile"
        with open(file_path, "rb") as f:
            res = requests.post(url, files={"file": f}).json()
        if res["status"] == "ok":
            return res["data"]["downloadPage"]
        else:
            return "❌ Upload failed"
    except Exception as e:
        return f"❌ Error: {e}"

link = upload_to_gofile("avica.txt")
print("✅ GoFile Upload Complete!")
print("🔗 Download Link:", link)
"@ | Out-File -Encoding utf8 setup.py

          # show.bat
          @"
@echo off
echo =======================================
echo   🚀 Avica RDP Connection Info
echo =======================================
type avica.txt
echo.
echo 🔗 GoFile Link was shown above in setup.py log
"@ | Out-File -Encoding ascii show.bat

          # loop.bat (keep alive)
          @"
:loop
timeout /t 300 >nul
goto loop
"@ | Out-File -Encoding ascii loop.bat

      - name: Install Python packages
        run: python -m pip install requests --quiet

      - name: Enable RDP + Set Password
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          net user runneradmin TheDisa1a
          Write-Host "✅ RDP Enabled & Password Set" -ForegroundColor Green

      - name: Run Setup (Generate GoFile Link)
        run: python setup.py

      - name: Show Connection Info
        run: cmd /c show.bat

      - name: Keep Session Active
        run: cmd /c loop.bat
