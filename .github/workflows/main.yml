name: AvicaRDP

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *" # Auto restart every 6 hours

jobs:
  build:
    name: Start Building...
    runs-on: windows-latest
    timeout-minutes: 350

    steps:
      - name: Download Required Files
        run: |
          Write-Host "ðŸš€ Downloading setup files..." -ForegroundColor Green

          # setup.py
          echo "import os" >> setup.py
          echo "import requests" >> setup.py
          echo "" >> setup.py
          echo "avica_id = '123-456-789'" >> setup.py
          echo "avica_pass = 'TheDisa1a'" >> setup.py
          echo "username = 'runneradmin'" >> setup.py
          echo "" >> setup.py
          echo "with open('avica.txt', 'w') as f:" >> setup.py
          echo "    f.write('ðŸ” Avica RDP Connection Info\\n')" >> setup.py
          echo "    f.write('=============================\\n')" >> setup.py
          echo "    f.write(f'ðŸ‘¤ User: {username}\\n')" >> setup.py
          echo "    f.write(f'ðŸ†” Avica ID: {avica_id}\\n')" >> setup.py
          echo "    f.write(f'ðŸ”‘ Password: {avica_pass}\\n')" >> setup.py
          echo "" >> setup.py
          echo "def upload_to_gofile(file_path):" >> setup.py
          echo "    try:" >> setup.py
          echo "        server = requests.get('https://api.gofile.io/getServer').json()['data']['server']" >> setup.py
          echo "        url = f'https://{server}.gofile.io/uploadFile'" >> setup.py
          echo "        with open(file_path, 'rb') as f:" >> setup.py
          echo "            res = requests.post(url, files={'file': f}).json()" >> setup.py
          echo "        if res['status'] == 'ok':" >> setup.py
          echo "            return res['data']['downloadPage']" >> setup.py
          echo "        else:" >> setup.py
          echo "            return 'âŒ Upload failed'" >> setup.py
          echo "    except Exception as e:" >> setup.py
          echo "        return f'âŒ Error: {e}'" >> setup.py
          echo "" >> setup.py
          echo "link = upload_to_gofile('avica.txt')" >> setup.py
          echo "print('âœ… GoFile Upload Complete!')" >> setup.py
          echo "print('ðŸ”— Download Link:', link)" >> setup.py

          # show.bat
          echo @echo off > show.bat
          echo echo ======================================= >> show.bat
          echo echo   ðŸš€ Avica RDP Connection Info >> show.bat
          echo echo ======================================= >> show.bat
          echo type avica.txt >> show.bat
          echo echo. >> show.bat
          echo echo ðŸ”— GoFile Link was shown above in setup.py log >> show.bat

          # loop.bat
          echo :loop > loop.bat
          echo timeout /t 300 ^>nul >> loop.bat
          echo goto loop >> loop.bat

      - name: Install Python packages
        run: python -m pip install requests --quiet

      - name: Enable RDP + Set Password
        run: |
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          net user runneradmin TheDisa1a
          Write-Host "âœ… RDP Enabled & Password Set" -ForegroundColor Green

      - name: Run Setup (Generate GoFile Link)
        run: python setup.py

      - name: Show Connection Info
        run: cmd /c show.bat

      - name: Keep Session Active
        run: cmd /c loop.bat
