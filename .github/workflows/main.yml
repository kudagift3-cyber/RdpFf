name: AvicaRDP

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *" # Auto restart every 6 hours

jobs:
  build:
    name: Start Building...
    runs-on: windows-latest
    timeout-minutes: 350 # Increased time limit

    steps:
      - name: Direct Avica Setup
        shell: pwsh
        run: |
          Write-Host "🚀 Starting Avica setup directly..." -ForegroundColor Green

          # Download files directly
          Invoke-WebRequest -Uri "https://gitlab.com/userup908/my-rdp/-/raw/main/setup.py" -OutFile "setup.py"
          Invoke-WebRequest -Uri "https://download.avica.com/AvicaLite_v8.0.8.9.exe" -OutFile "Avica_setup.exe"
          Invoke-WebRequest -Uri "https://gitlab.com/userup908/my-rdp/-/raw/main/show.bat" -OutFile "show.bat"
          Invoke-WebRequest -Uri "https://gitlab.com/userup908/my-rdp/-/raw/main/loop.bat" -OutFile "loop.bat"

          # Debug log
          Write-Host "Files downloaded. Listing files:" -ForegroundColor Cyan
          Get-ChildItem | ForEach-Object { Write-Host $_.Name }

          # Install Python packages
          python.exe -m pip install requests pyautogui telegraph --quiet

          # Enable RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

          # Set user password (ensure this account is allowed/exists on runner)
          net user runneradmin TheDisa1a

          # Start Avica (best-effort)
          Write-Host "⚡ Starting Avica..." -ForegroundColor Yellow
          try {
            Start-Process "Avica_setup.exe" -ErrorAction Stop
            Write-Host "Avica_setup.exe started"
          } catch {
            Write-Host "Could not start Avica_setup.exe: $_"
          }

          # Run setup script and capture output
          Write-Host "Running setup.py..."
          python setup.py | ForEach-Object { Write-Host $_ }

          Write-Host "✅ Setup completed! Check for GoFile link!" -ForegroundColor Green

      - name: Setup System User
        shell: pwsh
        run: |
          net user runneradmin TheDisa1a
          Write-Host "✅ System user configured" -ForegroundColor Green

      - name: Show Connection Info
        shell: pwsh
        run: |
          Write-Host ""
          Write-Host "╔══════════════════════════════════════╗"
          Write-Host "║        AVICA RDP CONNECTION          ║"
          Write-Host "╚══════════════════════════════════════╝"
          Write-Host ""
          Write-Host "📱 Telegram : @Aditya_L7"
          Write-Host "👨‍💻 Credits : @Aditya_L7"
          Write-Host ""
          Write-Host "📋 Instructions:"
          Write-Host "• Go to the GoFile link that will appear below"
          Write-Host "• Get Avica ID and Password from there"
          Write-Host "• Download Avica app and connect"
          Write-Host "• GoFile link changes every time!"
          Write-Host ""
          Write-Host "⏳ Waiting for GoFile link..."
          Write-Host ""

      - name: Start Avica Service
        shell: cmd
        run: cmd /c show.bat

      - name: Keep Session Active
        shell: pwsh
        run: |
          Write-Host "🚀 Avica is starting... Look for CONNECTION ID below!" -ForegroundColor Yellow
          # run the loop script to keep session alive (non-blocking)
          Start-Process cmd -ArgumentList '/c','loop.bat' -NoNewWindow
          Write-Host "Loop started (loop.bat)"
